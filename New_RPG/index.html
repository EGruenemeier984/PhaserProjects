<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Adventure RPG</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <meta name="description" content="Simple RPG Game">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Orbitron&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="RPGStyles.css" />
</head>

<body>
    <h1 style="text-align: center; font-size: 3.25em;">The Adventures of Bob</h1>
    <script>
        var BootScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

                function BootScene() {
                    Phaser.Scene.call(this, {
                        key: 'BootScene'
                    });
                },

            preload: function () {
                this.load.image("tiles", "assets/map/spritesheet.png");
                this.load.tilemapTiledJSON("map", "assets/map/map.json");
                this.load.spritesheet("player", "assets/RPG_assets.png", {
                    frameWidth: 16,
                    frameHeight: 16
                });
                this.load.image('dragonblue', 'assets/dragonblue.png');
                this.load.image('dragonorrange', 'assets/dragonorrange.png');
            },

            create: function () {
                //this.scene.start('WorldScene');
                this.scene.start('BattleScene');
            }
        });

        var BattleScene = new Phaser.Class({
            Extends: Phaser.Scene,

            initialize:

                function BattleScene() {
                    Phaser.Scene.call(this, {
                        key: 'BattleScene'
                    });
                },
            create: function () {
                // change the background to green
                this.cameras.main.setBackgroundColor('rgba(0, 200, 0, 0.5)');

                // player character - warrior
                var warrior = new PlayerCharacter(this, 250, 50, 'player', 1, 'Warrior', 100, 20);
                this.add.existing(warrior);

                // player character - mage
                var mage = new PlayerCharacter(this, 250, 100, 'player', 4, 'Mage', 80, 8);
                this.add.existing(mage);

                var dragonblue = new Enemy(this, 50, 50, 'dragonblue', null, 'Dragon', 50, 3);
                this.add.existing(dragonblue);

                var dragonOrange = new Enemy(this, 50, 100, 'dragonorrange', null, 'Dragon2', 50, 3);
                this.add.existing(dragonOrange);

                // array with heroes
                this.heroes = [warrior, mage];
                // array with enemies
                this.enemies = [dragonblue, dragonOrange];
                // array with both parties, who will attack
                this.units = this.heroes.concat(this.enemies);

                // Run UI Scene at the same time
                this.scene.launch('UIScene');
                
                // current active units in array
                this.index = -1;
            }

        });

        var UIScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

                function UIScene() {
                    Phaser.Scene.call(this, {
                        key: 'UIScene'
                    });
                },

            create: function () {
                this.graphics = this.add.graphics();
                this.graphics.lineStyle(1, 0xffffff);
                this.graphics.fillStyle(0x031f4c, 1);
                this.graphics.strokeRect(2, 150, 90, 100);
                this.graphics.fillRect(2, 150, 90, 100);
                this.graphics.strokeRect(95, 150, 90, 100);
                this.graphics.fillRect(95, 150, 90, 100);
                this.graphics.strokeRect(188, 150, 130, 100);
                this.graphics.fillRect(188, 150, 130, 100);

                this.menus = this.add.container();
                this.heroesMenu = new HeroesMenu(195, 153, this);
                this.actionMenu = new ActionMenu(100, 153, this);
                this.enemiesMenu = new EnemiesMenu(8, 153, this);
                this.currentMenu = this.actionsMenu;
                this.menus.add(this.heroesMenu);
                this.menus.add(this.actionMenu);
                this.menus.add(this.enemiesMenu);
                this.battleScene = this.scene.get("BattleScene");
                this.remapHeroes();
                this.remapEnemies();
                this.input.keyboard.on("keydown", this.onKeyInput, this);
            },

            onKeyInput: function () {
                if (this.currentMenu) {
                    if (event.code === "ArrowUp") {
                        this.currentMenu.moveSelectionUp();
                    } else if (event.code === "ArrowDown") {
                        this.currentMenu.moveSelectionDown();
                    } else if (event.code === "ArrowRight" || event.code === "Shift") {

                    } else if (event.code === "Space" || event.code === "ArrowLeft") {
                        this.currentMenu.confirm();
                    }
                }
            },

            remapHeroes: function () {
                var heroes = this.battleScene.heroes;
                this.heroesMenu.remap(heroes);
            },

            remapEnemies: function () {
                var enemies = this.battleScene.enemies;
                this.enemiesMenu.remap(enemies);
            }
        });

        var WorldScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

                function WorldScene() {
                    Phaser.Scene.call(this, {
                        key: 'WorldScene'
                    });
                },
            preload: function () {

            },
            create: function () {
                // sets the map tiles and sets the tiles boundaries
                var map = this.make.tilemap({
                    key: "map"
                });
                var tiles = map.addTilesetImage("spritesheet", "tiles");
                var grass = map.createStaticLayer("Grass", tiles, 0, 0);
                var obstacles = map.createStaticLayer("Obstacles", tiles, 0, 0);
                obstacles.setCollisionByExclusion([-1]);
                // Adds player sprite and physics plus sets a collision to the map.
                this.player = this.physics.add.sprite(50, 100, "player", 6);
                this.physics.world.bounds.width = map.widthInPixels;
                this.physics.world.bounds.height = map.heightInPixels;
                this.player.setCollideWorldBounds(true);
                // for player movement
                this.cursors = this.input.keyboard.createCursorKeys();
                // for camera to follow player
                this.cameras.main.setBounds(0, 0, map.widthInPixels, map.heightInPixels);
                this.cameras.main.startFollow(this.player);
                this.cameras.main.roundPixels = true;
                // animations
                this.anims.create({
                    key: "left",
                    frames: this.anims.generateFrameNumbers("player", {
                        frames: [1, 7, 1, 13]
                    }),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: "right",
                    frames: this.anims.generateFrameNumbers("player", {
                        frames: [1, 7, 1, 13]
                    }),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: "up",
                    frames: this.anims.generateFrameNumbers("player", {
                        frames: [2, 8, 2, 14]
                    }),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: "down",
                    frames: this.anims.generateFrameNumbers("player", {
                        frames: [0, 6, 0, 12]
                    }),
                    frameRate: 10,
                    repeat: -1
                });
                // hit obstacles 
                this.physics.add.collider(this.player, obstacles);
                // Zones for player to spawn
                this.spawns = this.physics.add.group({
                    classType: Phaser.GameObjects.Zone
                });
                for (var i = 0; i < 30; i++) {
                    var x = Phaser.Math.RND.between(0, this.physics.world.bounds.width);
                    var y = Phaser.Math.RND.between(0, this.physics.world.bounds.height);
                    this.spawns.create(x, y, 20, 20);
                }
                this.physics.add.overlap(this.player, this.spawns, this.onMeetEnemy, false, this);
            },

            update: function (time, delta) {
                this.player.setVelocity(0);
                // left and right movement
                this.cursors.left.isDown ? this.player.body.setVelocityX(-80) :
                    this.cursors.right.isDown ? this.player.body.setVelocityX(80) : null;
                // up and down movement
                this.cursors.up.isDown ? this.player.body.setVelocityY(-80) :
                    this.cursors.down.isDown ? this.player.body.setVelocityY(80) : null;
                // Update Animations
                this.cursors.left.isDown ? this.player.anims.play("left", true) :
                    this.cursors.right.isDown ? this.player.anims.play("right", true) :
                    this.cursors.up.isDown ? this.player.anims.play("up", true) :
                    this.cursors.down.isDown ? this.player.anims.play("down", true) :
                    this.player.anims.stop();
            },

            onMeetEnemy: function (player, zone) {
                // enemy code
                zone.x = Phaser.Math.RND.between(0, this.physics.world.bounds.width);
                zone.y = Phaser.Math.RND.between(0, this.physics.world.bounds.height);

                this.cameras.main.shake(300);
            }

        });

        var Unit = new Phaser.Class({
            Extends: Phaser.GameObjects.Sprite,

            initialize:

                function Unit(scene, x, y, texture, frame, type, hp, damage) {
                    Phaser.GameObjects.Sprite.call(this, scene, x, y, texture, frame)
                    this.type = type;
                    this.maxHp = this.hp = hp;
                    this.damage = damage; // default damage                
                },
            attack: function (target) {
                target.takeDamage(this.damage);
            },
            takeDamage: function (damage) {
                this.hp -= damage;
            }
        });

        var Enemy = new Phaser.Class({
            Extends: Unit,

            initialize:

                function Enemy(scene, x, y, texture, frame, type, hp, damage) {
                    Unit.call(this, scene, x, y, texture, frame, type, hp, damage);
                }
        });

        var PlayerCharacter = new Phaser.Class({
            Extends: Unit,

            initialize:

                function PlayerCharacter(scene, x, y, texture, frame, type, hp, damage) {
                    Unit.call(this, scene, x, y, texture, frame, type, hp, damage);
                    // flip the image so no more moon walking
                    this.flipX = true;

                    this.setScale(2);
                }
        });

        var MenuItem = new Phaser.Class({
            Extends: Phaser.GameObjects.Text,

            initialize:

                function MenuItem(x, y, text, scene) {
                    Phaser.GameObjects.Text.call(this, scene, x, y, text, {
                        color: '#ffffff',
                        align: 'left',
                        fontSize: 15
                    });
                },

            select: function () {
                this.setColor('#f8ff38');
            },

            deselect: function () {
                this.setColor('#ffffff');
            }

        });

        var Menu = new Phaser.Class({
            Extends: Phaser.GameObjects.Container,

            initialize:

                function Menu(x, y, scene, heroes) {
                    Phaser.GameObjects.Container.call(this, scene, x, y);
                    this.menuItems = [];
                    this.menuItemIndex = 0;
                    this.heroes = heroes;
                    this.x = x;
                    this.y = y;
                },
            addMenuItem: function (unit) {
                var menuItem = new MenuItem(0, this.menuItems.length * 20, unit, this.scene);
                this.menuItems.push(menuItem);
                this.add(menuItem);
            },
            moveSelectionUp: function () {
                this.menuItems[this.menuItemIndex].deselect();
                this.menuItemIndex--;
                if (this.menuItemIndex < 0)
                    this.menuItemIndex = this.menuItems.length - 1;
                this.menuItems[this.menuItemIndex].select();
            },
            moveSelectionDown: function () {
                this.menuItems[this.menuItemIndex].deselect();
                this.menuItemIndex++;
                if (this.menuItemIndex >= this.menuItems.length)
                    this.menuItemIndex = 0;
                this.menuItems[this.menuItemIndex].select();
            },
            // select the menu as a whole and an element with index from it
            select: function (index) {
                if (!index)
                    index = 0;
                this.menuItems[this.menuItemIndex].deselect();
                this.menuItemIndex = index;
                this.menuItems[this.menuItemIndex].select();
            },
            // deselect this menu
            deselect: function () {
                this.menuItems[this.menuItemIndex].deselect();
                this.menuItemIndex = 0;
            },
            confirm: function () {
                // when the player confirms his selection, do the action
            },

            clear: function () {
                for (var i = 0; i < this.menuItems.length; i++) {
                    this.menuItems[i].destroy();
                }
                this.menuItems.length = 0;
                this.menuItemIndex = 0;
            },

            remap: function (units) {
                this.clear();
                for (var i = 0; i < units.length; i++) {
                    var unit = units[i];
                    this.addMenuItem(unit.type);
                }
            }

        });

        var HeroesMenu = new Phaser.Class({
            Extends: Menu,

            initialize:

                function HeroesMenu(x, y, scene) {
                    Menu.call(this, x, y, scene);
                }
        });

        var ActionMenu = new Phaser.Class({
            Extends: Menu,

            initialize:

                function ActionsMenu(x, y, scene) {
                    Menu.call(this, x, y, scene);
                    this.addMenuItem("Attack");
                },
            confirm: function () {
                // action 
            }
        });

        var EnemiesMenu = new Phaser.Class({
            Extends: Menu,

            initialize:

                function EnemiesMenu(x, y, scene) {
                    Menu.call(this, x, y, scene);
                },
            confirm: function () {
                // action
            }
        })



        var config = {
            type: Phaser.AUTO,
            parent: 'content',
            width: 320,
            height: 240,
            zoom: 2,
            pixelArt: true,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {
                        y: 0
                    },
                    debug: true
                }
            },
            scene: [
                BootScene,
                WorldScene,
                BattleScene,
                UIScene
            ]
        };
        var game = new Phaser.Game(config);
    </script>
</body>

</html>